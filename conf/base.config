/* enable singularity and have it do automounts */
singularity.enabled = true
singularity.autoMounts = true

/*
 * parse out singularity bind directories
 * we have to check params['xxx-yyy'] because the case
 * translation hasn't happened yet (where does it happen?)
*/
def parameters = ''


/* the parameter case-translation hasn't happened yet for some reason, so let's force it */
if (!params.hasProperty('bind-dir')) {
  params['bind-dir'] = params.bindDir
}

if (!params.hasProperty('singularity-cache')) {
  params['singularity-cache'] = params.singularityCache
}

if (params.bindDir != '' || params['bind-dir'] != '') {
  def p = params.bindDir != '' ? params.bindDir : params['bind-dir']
  for (a in p.split()) {
    parameters = "${parameters} -B ${a}"
  }
  singularity.runOptions = parameters.substring(1)
}

/* get the singularity cache directory, if supplied */
if (params.singularityCache != '') {
  singularity.cacheDir = "${params.singularityCache}"
}
if (params['singularity-cache'] != '') {
  singularity.cacheDir = params['singularity-cache']
}

/*
 * general process options (mainly which labels go with which docker/singulariy images)
 * but also the base resource usage settings
*/
process {
  withLabel: 'fastqc'           { container = 'docker://biocontainers/fastqc:v0.11.9_cv7' }
  withLabel: 'adapterRemoval'   { container = 'docker://biocontainers/adapterremoval:v2.2.0-1-deb_cv1' }
  withLabel: 'obitools'         { container = 'quay.io/biocontainers/obitools:1.2.11--py27_1' }
  withLabel: 'usearch'          { container = 'docker://sunqiangkun/usearch:v1' }
  withLabel: 'vsearch'          { container = 'docker://biocontainers/vsearch:v2.10.4-1-deb_cv1' }
  withLabel: 'blast'            { container = 'docker://ncbi/blast:latest'  }
  withLabel: 'lulu'             { container = 'docker://index.docker.io/mahsamousavi/lulu:2019' }
  withLabel: 'lca_python3'      { container = 'docker://python:3.6'}
  withLabel: 'multiqc'          { container = 'docker://quay.io/biocontainers/multiqc:1.14--pyhdfd78af_0'}
  withLabel: 'insect'           { container = 'docker://mahsamousavi/insect:2019'}

  cache = 'lenient' 

  cpus = { check_max( 1 * task.attempt, 'cpus' ) }
  memory = { check_max( 6.GB * task.attempt, 'memory' ) }
  time = { check_max( 4.h * task.attempt, 'time' ) }
}
